# Project PFE – Day 8 Implementation Log

**Date:** 2026-02-18  
**Goal (Day 8):** Implement backend token-based authentication using Laravel Sanctum. Establish secure user registration, login, logout, and protected routes while keeping document endpoints intentionally unprotected .

---

## Deliverables (created/updated)

- `app/Http/Controllers/Api/AuthController.php`
- `app/Models/User.php` *(HasApiTokens trait verified)*
- `routes/api.php` *(auth routes added, rate limiting)*
- `config/sanctum.php` *(published)*
- `database/migrations/xxxx_create_personal_access_tokens_table.php` *(already present)*
- `docs/AUTH.md` *(authentication documentation)*

> Frontend: No changes (Day 9 planned).  
> FastAPI: No changes.  
> Document routes intentionally left unprotected (Day 10).

---

## Implementation Timeline

| Phase | Activities | Key Deliverables |
|-------|------------|------------------|
| Phase 0: Pre-checks | Verify services, migrations, clean repo | Stable baseline |
| Phase 1: Sanctum verification | Confirm Sanctum installed, tokens table, User model | HasApiTokens confirmed |
| Phase 2: Auth API implementation | Create register/login/logout/me, validations, tokens | AuthController, routes |
| Phase 3: API testing | Postman tests success/failure, token revocation | Results validated |
| Phase 4: Documentation | Write docs/AUTH.md | Complete documentation |

---

## 1) Pre-Implementation Verification

### 1.1 System checks

- Branch clean and up to date with origin/main
- All migrations applied
- Database available and stable
- Existing document workflow unaffected

### 1.2 Servers

- Laravel API (port 8000) operational
- Queue worker active
- FastAPI (port 8001) active
- React frontend (port 5173) active

### 1.3 Sanctum verification

Laravel 11 includes Sanctum by default. Verification performed:

```bash
composer show laravel/sanctum
# Version: v3.3.3 (already installed)

php artisan migrate:status
# personal_access_tokens [1] Ran
```

**User model:** `HasApiTokens` trait already present on `App\Models\User`. No installation or migration changes required; implementation proceeded to AuthController.

---

## 2) Backend (Laravel) – Auth API

### 2.1 Architecture decisions

**Auth method:** Token authentication (Bearer tokens). Session (SPA) authentication not used.

**Justification:** Token-based authentication is fully appropriate for this project because the application is an internal insurance system, accessible only to authenticated employees within a controlled company network. In this context, simplicity, maintainability, and operational efficiency take priority over public-grade security complexity, making Sanctum Bearer tokens a secure and pragmatic architectural choice.

**Protection scope:**
- Protected: `/logout`, `/me` (require `auth:sanctum`)
- Document routes: not protected (intentional for Day 8; frontend has no login UI yet)

### 2.2 AuthController

**File:** `app/Http/Controllers/Api/AuthController.php`

**Endpoints:**

| Method | URL | Purpose |
|--------|-----|---------|
| POST | `/api/register` | Register user, return token |
| POST | `/api/login` | Authenticate, return token |
| POST | `/api/logout` | Revoke current token |
| GET | `/api/me` | Return authenticated user |

**Register:** Body `name`, `email`, `password`, `password_confirmation`. Validation: name required string max 255; email required email unique; password required min 8 confirmed. Response 201: `message`, `user`, `token`.

**Login:** Body `email`, `password`. Uses `Auth::attempt()` (timing-safe). Response 200: `message`, `user`, `token`. Error 422: credentials incorrect.

**Logout:** Requires `Authorization: Bearer {token}`. Revokes current token only. Response 200: `message`.

**Me:** Requires `Authorization: Bearer {token}`. Response 200: `user` (id, name, email). Without token: 401 Unauthenticated.

### 2.3 API routes

**File:** `routes/api.php`

**Public (rate-limited):**
- `POST /api/register` with `throttle:5,1`
- `POST /api/login` with `throttle:5,1`

**Protected (`auth:sanctum`):**
- `POST /api/logout`
- `GET /api/me`

**Document routes:** Unchanged; no `auth:sanctum` middleware (intentional).

### 2.4 Rate limiting

- `throttle:5,1`: maximum 5 requests per minute per IP
- Returns HTTP 429 when exceeded
- Applied to register and login to reduce brute-force risk

---

## 3) API Changes

### 3.1 New endpoints

| Method | URL | Auth | Purpose |
|--------|-----|------|---------|
| POST | `/api/register` | No | Register, receive token |
| POST | `/api/login` | No | Login, receive token |
| POST | `/api/logout` | Bearer | Revoke current token |
| GET | `/api/me` | Bearer | Current user |

### 3.2 Response samples

**Register (201):**
```json
{
  "message": "User registered successfully.",
  "user": { "id": 1, "name": "...", "email": "...", "created_at": "..." },
  "token": "1|..."
}
```

**Login (200):**
```json
{
  "message": "Login successful.",
  "user": { ... },
  "token": "2|..."
}
```

**Me (200):**
```json
{
  "user": { "id": 1, "name": "Agent", "email": "agent@example.com" }
}
```

**Unauthenticated (401):**
```json
{ "message": "Unauthenticated." }
```

---

## 4) Testing & Validation

### 4.1 Postman test suite

**Collection:** Day 8 – Auth Testing

| Test | Description | Result |
|------|-------------|--------|
| 1 | Register new user | Passed |
| 2 | Duplicate email returns 422 | Passed |
| 3 | Login success returns token | Passed |
| 4 | Login wrong password returns 422 | Passed |
| 5 | GET /me with valid token returns 200 | Passed |
| 6 | GET /me without token returns 401 | Passed |
| 7 | Logout returns 200 | Passed |
| 8 | Token invalid after logout (401 on /me) | Passed |
| 9 | GET /documents without token returns 200 (scope respected) | Passed |

**Total:** 9 tests, 9 passed.

### 4.2 Security verification

- Duplicate email rejected (validation)
- Invalid credentials return 422 with generic message
- Protected routes return 401 without token
- Token revoked after logout; same token returns 401

---

## 5) Database Verification

### 5.1 personal_access_tokens

- Tokens stored hashed (not plaintext)
- Token name: `auth_token`
- `tokenable_type`: `App\Models\User`; `tokenable_id`: user ID
- Row removed after logout

### 5.2 users table

- Password hashed with bcrypt
- Email unique
- Standard Laravel schema

---

## 6) Documentation

**File:** `docs/AUTH.md`

**Contents:** System overview, technical stack, authentication flow, endpoint list, validation rules, security features, `personal_access_tokens` schema, test summary, next steps. Format: Markdown, concise.

---

## 7) Problems Encountered

### 7.1 Route not found (404)

**Symptom:** `The route api/register could not be found.`

**Cause:** Route cache not cleared after adding new routes.

**Solution:**
```bash
php artisan route:clear
php artisan route:cache
```

**Status:** Resolved

### 7.2 Other

No further issues. Sanctum already installed and User model already configured; implementation proceeded without additional setup.

---

## 8) Architecture Validation

### Authentication flow

```
REGISTER / LOGIN
    |
    v
Token generated (Sanctum)
    |
    v
Client sends Authorization: Bearer <token>
    |
    v
Protected routes: /me, /logout
```

### System components (auth scope)

```
+------------------+
| Client (Postman) |
| register/login   |
| me/logout        |
+--------+---------+
         |
         v
+--------+--------------------------------+
| Laravel API (:8000)                    |
| - AuthController                       |
| - auth:sanctum middleware              |
| - Rate limiting (throttle:5,1)          |
+--------+--------------------------------+
         |
         v
+--------+--------------------------------+
| MySQL                                  |
| - users                                |
| - personal_access_tokens               |
+----------------------------------------+
```

Document workflow unchanged; document endpoints remain unprotected at this stage.

---


## 9) Sprint 4 Progress

### Stories completed (Day 8)

| Story ID | Description | Points | Status |
|----------|-------------|--------|--------|
| US-022 | Backend Sanctum authentication | 8 | Complete |
| TS-039 | Auth endpoints (register/login/logout/me) | 5 | Complete |
| TS-040 | Rate limiting on auth routes | 2 | Complete |
| TS-041 | Complete API auth tests | 3 | Complete |

**Day 8 Story Points:** 18/18

### Cumulative Sprint 4 progress

| Story ID | Description | Points | Day | Status |
|----------|-------------|--------|-----|--------|
| US-022 | Backend auth | 8 | Day 8 | Complete |
| TS-039 | Auth endpoints | 5 | Day 8 | Complete |
| TS-040 | Rate limiting | 2 | Day 8 | Complete |
| TS-041 | API auth tests | 3 | Day 8 | Complete |

**Sprint 4 total (to date):** 18/40 story points

---

## 10) System State at End of Day 8

### Current capabilities

- Backend authentication operational (Sanctum)
- Register and login return valid tokens
- Protected routes require valid Bearer token
- Logout revokes current token
- Document endpoints still accessible without auth (intentional)
- Rate limiting active on register and login
- Validation and 401/422 handling correct


## Out of Scope (intentional for Day 8)

- Frontend auth UI (Day 9)
- Document route protection (Day 10)
- Token expiration and refresh
- Password reset flow
- Email verification
- User profile page
- RBAC (admin, agent roles)
