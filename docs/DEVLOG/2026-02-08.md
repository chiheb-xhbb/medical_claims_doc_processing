# Project PFE – Day 2 Design Log (Flow, Architecture, Contracts)

**Date:** 2026-02-08  
**Goal (Day 2):** verrouiller le comportement du système **avant de coder** (flow, architecture, contrats, DB conceptuelle, diagramme).

---

## Deliverables (created/updated)

- `docs/diagrams/document-processing-flow.md`
- `docs/diagrams/document-processing-flow.drawio`
- `docs/diagrams/document-processing-flow.png` 
- `docs/architecture.md`
- `docs/api-contract.md`
- `docs/database-design.md`

---

## 1) Document Processing Flow (MVP)

**File:** `docs/diagrams/document-processing-flow.md`

### Summary (MVP)
- Upload document médical (PDF/Image) via **React**.
- Envoi du fichier à **Laravel** en `multipart/form-data`.
- Laravel :
  - valide le fichier (MIME/extension/taille),
  - stocke le fichier original (`storage/app/documents/`),
  - pilote le workflow via statuts.
- Laravel appelle **FastAPI** via `POST /process`.
- FastAPI retourne un JSON (`fields`, `confidence`, `warnings`, `errors`, `meta`).
- Laravel enregistre le résultat (JSON) et met à jour le statut.
- **HITL** : l’utilisateur corrige/valide, Laravel historise puis finalise.

### Statuts (MVP)
- `UPLOADED` → fichier reçu/validé/stocké
- `PROCESSING` → traitement IA en cours
- `PROCESSED` → résultat IA enregistré
- `VALIDATED` → validation humaine terminée
- `FAILED` → échec du traitement IA (erreur enregistrée)

### Ownership rules
- **Laravel** : stockage, statuts/workflow, DB, traçabilité.
- **FastAPI** : traitement OCR/extraction, **stateless** (pas de DB, pas de stockage).

---

## 2) Architecture Notes (MVP)

**File:** `docs/architecture.md`

### Key decisions
- **React communique uniquement avec Laravel.**  
  FastAPI est appelé **uniquement par Laravel**.
- Laravel : auth API (Sanctum) + contrôle d’accès, orchestration, persistance, traçabilité.
- FastAPI : pipeline OCR/extraction + score de confiance (implémentation détaillée ultérieure), stateless.

### Local ports
- React (Vite) : `http://localhost:5173`
- Laravel (artisan serve) : `http://127.0.0.1:8000`
- FastAPI (uvicorn) : `http://127.0.0.1:8001`

---

## 3) AI API Contract v1 (Frozen)

**File:** `docs/api-contract.md`

### Endpoint
- `POST /process`

### Request
- `multipart/form-data`
  - `file` (required)
  - `doc_type` (optional: `pharmacy_invoice | lab_report | unknown`)

### Response (v1)
- `fields`: `invoice_date`, `provider_name`, `total_ttc`
- `confidence`: score par champ (`0.0` → `1.0`)
- `warnings`, `errors`, `meta` (ex: `request_id`, `processing_time_ms`, `ocr_engine`, `doc_type`)
- Codes HTTP documentés : `200`, `400`, `500`

### Integration rule
- **Contract v1 frozen** : pas de changement cassant (breaking change) après Day 2 sans mise à jour coordonnée Laravel/React.

---

## 4) Database Design (Conceptual – MVP)

**File:** `docs/database-design.md`

### Conceptual tables (MVP)
- `documents` : métadonnées fichier + `status` + `doc_type`
- `ai_requests` : traçabilité des appels Laravel → FastAPI (timing, HTTP status, erreurs)
- `extractions` : résultat IA (JSON brut + versionnement simple)
- `field_corrections` : audit des corrections HITL (ancienne valeur, nouvelle valeur, utilisateur, date)

### Persistence rule
- Laravel persiste (DB + fichiers).
- FastAPI ne persiste rien.

---

## 5) Flow Diagram (Report-ready)

**Files:**
- `docs/diagrams/document-processing-flow.drawio` (source éditable)
- `docs/diagrams/document-processing-flow.png` 

### Diagram scope
- Swimlanes : React / Laravel / FastAPI / MySQL+Stockage
- Chemin nominal + gestion d’erreurs :
  - fichier invalide → 400 + message utilisateur
  - erreur IA/timeout → statut `FAILED` + affichage erreur

---

## Out of scope (intentional for Day 2)
- Pas de tuning OCR / pas d’entraînement IA
- Pas de styling UI / pas de features front
- Pas de migrations DB / pas d’implémentation code

