# Project PFE – Day 5 Implementation Log

**Date:** 2026-02-14  
**Goal (Day 5):** Replace the AI mock with real FastAPI OCR integration (Tesseract), establish HTTP communication between Laravel and FastAPI, and implement field extraction with confidence scoring.

---

## Deliverables (created/updated)

- `ai/main.py` (complete rewrite with real OCR)
- `ai/requirements.txt` (updated dependencies)
- `backend/app/Services/AIService.php` (replaced mock with HTTP client)
- `backend/app/Jobs/ProcessDocumentJob.php` (updated for real integration)
- `backend/config/services.php` (added FastAPI configuration)
- `backend/.env` (added `FASTAPI_URL`)

---

## 1) Environment Setup

### 1.1 Python Dependencies

**File:** `ai/requirements.txt`

```
fastapi>=0.100.0
uvicorn>=0.23.0
python-multipart>=0.0.6
pytesseract>=0.3.10
Pillow>=10.0.0
PyMuPDF>=1.23.0
```

Installation:
```bash
pip install -r requirements.txt
```

### 1.2 Tesseract OCR Installation (Windows)

**Problem encountered:**
```
TesseractNotFoundError: tesseract is not installed or it's not in your PATH
```

**Solution:**
- Downloaded Tesseract installer from UB-Mannheim repository
- Installed to `C:\Program Files\Tesseract-OCR`
- Configured path in `ai/main.py`:

```python
import pytesseract
pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
```

**Result:** OCR operational with French and English language support.

### 1.3 Laravel Configuration

**File:** `backend/config/services.php`
```php
'fastapi' => [
    'url' => env('FASTAPI_URL', 'http://127.0.0.1:8001'),
],
```

**File:** `backend/.env`
```env
FASTAPI_URL=http://127.0.0.1:8001
```

---

## 2) FastAPI Implementation

**File:** `ai/main.py`

### 2.1 Endpoint Structure

**Route:** `POST /process`

**Request:**
- `file`: Binary file (multipart/form-data)
- `doc_type`: Optional string hint

**Response:** Contract v1 compliant JSON

### 2.2 Stable Response Structure

**Design decision:** All required fields are always present, even when null.

```python
REQUIRED_FIELDS = ["invoice_date", "provider_name", "total_ttc"]

# Initialization guarantees key presence
fields = {key: None for key in REQUIRED_FIELDS}
confidence = {key: 0.0 for key in REQUIRED_FIELDS}
```

**Benefit:** Frontend never encounters missing keys.

### 2.3 Multi-Format Support

| Format | Processing Method |
|--------|-------------------|
| JPG, PNG, BMP, TIFF | Direct OCR |
| PDF | First page rendered at 200 DPI, then OCR |

**PDF implementation:**
```python
with fitz.open(stream=contents, filetype="pdf") as pdf_document:
    page = pdf_document[0]
    pix = page.get_pixmap(dpi=200)
    image = Image.open(io.BytesIO(pix.tobytes("png")))
```

**Image preprocessing:**
```python
if image.mode != 'L':
    image = image.convert('L')  # Grayscale conversion

text = pytesseract.image_to_string(image, lang='fra+eng')
```

### 2.4 Field Extraction (Regex-based)

**Date extraction:**
```python
date_pattern = r'(\d{2}[/-]\d{2}[/-]\d{4}|\d{4}[/-]\d{2}[/-]\d{2})'
```
Supported formats: `DD/MM/YYYY`, `DD-MM-YYYY`, `YYYY-MM-DD`

**Amount extraction:**
```python
amount_pattern = r'(?:total|ttc|montant)[^\d]*(\d+[.,]\d{2})\s*(?:€|EUR|DT|TND)?'
```

**Provider name extraction:**
- Uses first non-header line
- Skips common header words: facture, invoice, labo, laboratoire, pharmacie

**Date normalization:**
```python
def normalize_date(date_str: str) -> str:
    formats = ["%d/%m/%Y", "%d-%m-%Y", "%Y-%m-%d", "%Y/%m/%d"]
    for fmt in formats:
        try:
            return datetime.strptime(date_str, fmt).strftime("%Y-%m-%d")
        except ValueError:
            continue
    return date_str
```

### 2.5 Confidence Scoring

| Field | Condition | Score |
|-------|-----------|-------|
| invoice_date | Pattern matched | 0.85 |
| total_ttc | Pattern matched | 0.80 |
| provider_name | Heuristic match | 0.65 |
| Any field | Not extracted | 0.0 |

### 2.6 Warning Generation

```python
def generate_warnings(fields: dict, confidence: dict) -> list:
    warnings = []
    for field_name in REQUIRED_FIELDS:
        value = fields.get(field_name)
        score = confidence.get(field_name, 0.0)
        
        if value is None:
            warnings.append(f"Missing required field: '{field_name}'")
        elif score < 0.70:
            warnings.append(f"Low confidence for field '{field_name}': {score:.0%}")
    
    return warnings
```

### 2.7 Error Response Consistency

**Design decision:** Error responses maintain the same structure as success responses.

```python
return JSONResponse(
    status_code=400,
    content={
        "meta": {...},
        "fields": fields,      # Same keys, null values
        "confidence": confidence,  # Same keys, 0.0 values
        "warnings": [],
        "errors": [str(e)]
    }
)
```

**Benefit:** Frontend parsing logic remains consistent.

---

## 3) Laravel Integration

### 3.1 AIService HTTP Client

**File:** `backend/app/Services/AIService.php`

**Key implementation:**
```php
public function process(string $filePath, ?string $docType = null): array
{
    $fullPath = Storage::disk('local')->path($filePath);

    if (!file_exists($fullPath)) {
        throw new \Exception("File not found: {$filePath}");
    }

    Log::info('AIService: Calling FastAPI', [
        'file_path' => $filePath,
        'doc_type' => $docType,
        'file_size' => filesize($fullPath)
    ]);

    $response = Http::timeout(30)
        ->attach('file', fopen($fullPath, 'r'), basename($filePath))
        ->post($this->fastApiUrl . '/process', [
            'doc_type' => $docType ?? 'unknown'
        ]);

    if ($response->successful()) {
        $data = $response->json();
        
        Log::info('AIService: FastAPI success', [
            'request_id' => $data['meta']['request_id'] ?? 'unknown',
            'processing_time_ms' => $data['meta']['processing_time_ms'] ?? 0
        ]);
        
        return $data;
    }

    throw new \Exception("FastAPI error (HTTP {$response->status()})");
}
```

**Features:**
- 30 second timeout
- Multipart file upload via `Http::attach()`
- Separate handling for `ConnectionException`
- Detailed logging with request_id

### 3.2 ProcessDocumentJob Updates

**File:** `backend/app/Jobs/ProcessDocumentJob.php`

**Key changes:**

**Extraction version constant:**
```php
private const EXTRACTION_VERSION = 1;
```

**Processing time tracking:**
```php
private float $startTime;

private function getElapsedTimeMs(): int
{
    return (int) ((microtime(true) - $this->startTime) * 1000);
}
```

**Real FastAPI call:**
```php
$result = app(AIService::class)->process(
    $document->file_path,
    $document->doc_type
);
```

**Enhanced logging:**
```php
$extractedFields = array_keys(array_filter(
    $result['fields'] ?? [],
    fn($v) => $v !== null
));

Log::info('ProcessDocumentJob: Success', [
    'document_id' => $this->documentId,
    'request_id' => $result['meta']['request_id'] ?? 'unknown',
    'processing_time_ms' => $result['meta']['processing_time_ms'],
    'fields_extracted' => $extractedFields,
    'warnings_count' => count($result['warnings'] ?? [])
]);
```

**Error message truncation:**
```php
'error_message' => mb_substr($exception->getMessage(), 0, 1000),
```

---

## 4) Contract v1 Format

**Final structure:**
```json
{
  "meta": {
    "doc_type": "pharmacy_invoice | lab_report | radiology | unknown",
    "request_id": "uuid-v4",
    "processing_time_ms": 1234,
    "ocr_engine": "tesseract",
    "extra": {
      "patient_name": "...",
      "text_length": 656,
      "text_preview": "..."
    },
    "note": "MVP: first page only for multi-page PDFs"
  },
  "fields": {
    "invoice_date": "YYYY-MM-DD | null",
    "provider_name": "string | null",
    "total_ttc": "number | null"
  },
  "confidence": {
    "invoice_date": 0.0-1.0,
    "provider_name": 0.0-1.0,
    "total_ttc": 0.0-1.0
  },
  "warnings": ["..."],
  "errors": []
}
```

**Contract guarantees:**
- Required fields always present (even if null)
- Confidence scores for all required fields
- Warnings generated automatically
- Extra fields stored in `meta.extra`
- Identical structure for success and error responses

---

## 5) Testing Results

### 5.1 Test History

| Document ID | Status | Cause | Resolution |
|-------------|--------|-------|------------|
| 2 | SUCCESS | - | Initial test passed |
| 3 | FAILED | FastAPI not running | Started uvicorn |
| 4 | FAILED | Tesseract not installed | Installed binary and configured path |
| 5 | SUCCESS | - | Final validation passed |

### 5.2 Final Test (Document ID 5)

**File:** `facture3.png` (63 KB)  
**Type:** Pharmacy invoice

**FastAPI response:**
```json
{
  "meta": {
    "doc_type": "unknown",
    "request_id": "829c8bb0-6618-4b93-8cf9-6091d4972a7d",
    "processing_time_ms": 1389,
    "ocr_engine": "tesseract",
    "extra": {
      "text_length": 656,
      "text_preview": "Pharmacie Nom et Adresse No recu..."
    }
  },
  "fields": {
    "invoice_date": null,
    "provider_name": "Ma pharmacie locale Annie Morin 123456",
    "total_ttc": 95.52
  },
  "confidence": {
    "invoice_date": 0.0,
    "provider_name": 0.65,
    "total_ttc": 0.80
  },
  "warnings": [
    "Missing required field: 'invoice_date'",
    "Low confidence for field 'provider_name': 65%"
  ],
  "errors": []
}
```

### 5.3 Extraction Quality Analysis

| Field | Expected Value | Extracted Value | Confidence | Status |
|-------|----------------|-----------------|------------|--------|
| total_ttc | 95.52 | 95.52 | 80% | Exact match |
| provider_name | Ma pharmacie locale | Ma pharmacie locale Annie Morin 123456 | 65% | Partial (includes adjacent columns) |
| invoice_date | 04 avril 2017 | null | 0% | Not extracted (month name format) |

**Analysis:**
- Monetary extraction works correctly via regex pattern
- Provider name includes OCR artifacts from adjacent table columns
- Date extraction limited to numeric formats (French month names not supported in MVP)

### 5.4 Database Verification

**Table: documents**
```sql
SELECT id, status, original_filename FROM documents WHERE id = 5;
-- Result: id=5, status='PROCESSED', original_filename='facture3.png'
```

**Table: ai_requests**
```sql
SELECT id, document_id, status, processing_time_ms FROM ai_requests WHERE document_id = 5;
-- Result: id=4, document_id=5, status='SUCCESS', processing_time_ms=1389
```

**Table: extractions**
```sql
SELECT id, document_id, version FROM extractions WHERE document_id = 5;
-- Result: id=4, document_id=5, version=1
```

---

## 6) Performance Metrics

| Metric | Value | Target | Status |
|--------|-------|--------|--------|
| FastAPI processing time | 1389 ms | < 5000 ms | Acceptable |
| End-to-end job time | ~4000 ms | < 10000 ms | Acceptable |
| OCR text length | 656 chars | > 100 chars | Good |
| Post-setup failure rate | 0% | < 5% | Excellent |

---

## 7) Architecture Validation

### Workflow (current state)
```
UPLOADED (t=0s)
    |
    v
PROCESSING (t=1s)
    |
    v [FastAPI OCR call]
    |
PROCESSED (t=4s) or FAILED
```

### System components

```
+----------------+
|    Client      | POST /api/documents
+-------+--------+
        |
        v
+-------+----------------------------------+
|   LARAVEL API (:8000)                   |
|   - DocumentController::store()         |
|   - Document -> UPLOADED                |
|   - ProcessDocumentJob::dispatch()      |
+-------+----------------------------------+
        |
        v [afterCommit()]
+-------+----------------------------------+
|   QUEUE WORKER                          |
|   - ProcessDocumentJob::handle()        |
|   - Status -> PROCESSING                |
|   - AIService::process()                |
+-------+----------------------------------+
        |
        v [HTTP POST multipart]
+-------+----------------------------------+
|   FASTAPI (:8001)                       |
|   - /process endpoint                   |
|   - PyMuPDF (PDF -> image)              |
|   - Tesseract OCR                       |
|   - Regex extraction                    |
|   - Confidence scoring                  |
+-------+----------------------------------+
        |
        v [JSON Response]
+-------+----------------------------------+
|   LARAVEL PERSISTENCE                   |
|   - DB::transaction()                   |
|   - AiRequest::create()                 |
|   - Extraction::create()                |
|   - Document -> PROCESSED               |
+------------------------------------------+
```

### Day 2 design compliance
- Laravel owns workflow states and persistence
- FastAPI handles AI processing only (stateless)
- Full AI response stored in `extractions.result_json`
- Audit trail maintained in `ai_requests`
- Idempotence protections preserved

---

## 8) Problems Encountered and Solutions

| Problem | Cause | Solution | Time |
|---------|-------|----------|------|
| ModuleNotFoundError: pytesseract | Missing Python dependency | `pip install pytesseract pillow PyMuPDF` | 15 min |
| TesseractNotFoundError | Binary not installed | Install Tesseract + configure path | 20 min |
| FastAPI 500 Error | Tesseract path not configured in code | Add `pytesseract.pytesseract.tesseract_cmd` | 10 min |
| Connection Refused (Doc 3) | FastAPI not running | Start uvicorn before testing | 5 min |

**Total debugging time:** ~50 minutes

---

## 9) Known Limitations (MVP Scope)

| Limitation | Impact | Mitigation | Future Resolution |
|------------|--------|------------|-------------------|
| Numeric date formats only | Dates like "04 avril 2017" not extracted | Warning generated automatically | Add French month patterns |
| Provider name heuristic | Adjacent OCR columns merged | Confidence set to 65% | Implement table structure parsing |
| PDF first page only | Multi-page documents incomplete | Documented in `meta.note` | Add multi-page support if needed |

---

## 10) Files Modified Summary

### FastAPI
| File | Lines | Description |
|------|-------|-------------|
| `ai/main.py` | ~250 | Complete OCR endpoint implementation |
| `ai/requirements.txt` | 6 | Updated dependencies |

### Laravel
| File | Lines | Description |
|------|-------|-------------|
| `app/Services/AIService.php` | ~80 | HTTP client replacing mock |
| `app/Jobs/ProcessDocumentJob.php` | ~120 | Real integration with timing |
| `config/services.php` | +4 | FastAPI URL configuration |
| `.env` | +1 | FASTAPI_URL variable |

---

## 11) Sprint 3 Progress

| Story ID | Description | Points | Status |
|----------|-------------|--------|--------|
| US-011 | HTTP FastAPI integration | 5 | Completed |
| US-015 | Failure audit trail | 2 | Completed |
| US-016 | Idempotence guards | 3 | Completed |
| TS-036 | AIService refactoring | 2 | Completed |
| US-017 | Extraction display UI (React) | 5 | Planned Day 6 |
| US-018 | Field correction UI | 5 | Planned Day 6 |

**Day 5 progress:** 12/22 SP (55%)

---

## 12) System State at End of Day 5

### Current capabilities
- Real OCR processing via FastAPI and Tesseract
- Regex-based field extraction (date, amount, provider)
- Confidence scoring with automatic thresholds
- Warning generation for missing or low-confidence fields
- HTTP communication Laravel to FastAPI
- Full audit trail (ai_requests table)
- Extraction storage with versioning
- Retry mechanism with failure handling

### Current workflow
```
UPLOADED
    |
PROCESSING (queue + FastAPI OCR)
    |
PROCESSED / FAILED
    |
VALIDATED (planned Day 6+)
```

---

## Out of Scope (intentional for Day 5)

- Advanced NLP extraction
- French month name date parsing
- Multi-page PDF processing
- Frontend HITL validation UI
- WebSocket real-time updates
- Production deployment (Docker/Nginx)
- Field correction and submission
- Table `field_corrections` implementation