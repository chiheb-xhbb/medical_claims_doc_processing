# Project PFE – Day 9 Implementation Log

**Date:** 2026-02-19
**Goal (Day 9):** Implement frontend authentication layer (Login UI + Token Handling + Route Protection) and integrate React with Laravel Sanctum backend authentication.

---

## Deliverables (created/updated)

* `frontend/src/pages/Login.jsx`
* `frontend/src/components/ProtectedRoute.jsx`
* `frontend/src/services/api.js`
* `frontend/src/services/auth.js`
* `frontend/src/utils/setAuthToken.js`
* `frontend/src/components/Navbar.jsx` *(authentication integration)*
* `frontend/src/App.jsx` *(persistent token initialization + protected routes)*

> Backend: No changes.
> FastAPI: No changes.
> Document routes remain unprotected at backend level (Day 10 planned).

---

## 1) Pre-Implementation Verification

Before implementing frontend authentication, backend functionality from Day 8 was verified.

### 1.1 Backend checks performed

* `POST /api/login` returns valid token
* `GET /api/me` works with Bearer token
* `POST /api/logout` revokes token correctly
* Document routes remain accessible without token (intentional)
* personal_access_tokens table functioning correctly

All checks passed.

---

## 2) Frontend Architecture Enhancements

### 2.1 Folder Structure Introduced

```
frontend/src/
 ├── components/
 │     └── ProtectedRoute.jsx
 ├── pages/
 │     └── Login.jsx
 ├── services/
 │     ├── api.js
 │     └── auth.js
 └── utils/
       └── setAuthToken.js
```

Separation of concerns:

* UI Layer → pages/
* Reusable components → components/
* API communication → services/
* Token management utility → utils/

Structure aligned with previous frontend modularization (Day 7).

---

## 3) Axios Configuration (api.js)

### 3.1 Axios Instance

Base configuration:

* Base URL: `http://127.0.0.1:8000/api`
* Headers:

  * `Content-Type: application/json`
  * `Accept: application/json`

All API calls centralized through this instance.

### 3.2 Global 401 Interceptor

Response interceptor implemented:

* Detects `401 Unauthenticated`
* Removes `auth_token` from localStorage
* Deletes Authorization header
* Redirects to `/login`

Ensures automatic logout on:

* Expired token
* Revoked token
* Invalid token

Prevents inconsistent auth states.

---

## 4) Token Lifecycle Management

### 4.1 setAuthToken Utility

**File:** `frontend/src/utils/setAuthToken.js`

Responsibilities:

* If token exists → set `Authorization: Bearer {token}`
* If null → remove Authorization header

Centralized token header logic avoids duplication.

---

## 5) Authentication Service Layer

**File:** `frontend/src/services/auth.js`

Implemented functions:

| Function               | Purpose                                    |
| ---------------------- | ------------------------------------------ |
| login(email, password) | Authenticate and store token               |
| logout()               | Revoke backend token and clear local token |
| getCurrentUser()       | Fetch authenticated user                   |
| isAuthenticated()      | Check token presence                       |

### 5.1 Login Flow

* Calls `POST /api/login`
* Stores token in localStorage as `auth_token`
* Calls `setAuthToken(token)`
* Returns `{ token, user }`

### 5.2 Logout Flow

* Calls `POST /api/logout`
* Clears localStorage
* Removes Authorization header
* Uses try/finally to guarantee cleanup

---

## 6) Login Page Implementation

**File:** `frontend/src/pages/Login.jsx`
**Route:** `/login`

### 6.1 Features

* Email + Password fields
* Client-side validation:

  * Required fields
  * Email format validation
* Loading state
* Disabled inputs during request
* Error handling:

  * 401 → Invalid credentials
  * 422 → Backend validation errors
  * Network failure detection
* Bootstrap 5 card layout
* Spinner during login
* Redirect to `/documents` using `navigate(..., { replace: true })`

### 6.2 UX Decision

Navbar intentionally hidden on login page for layout clarity.
Navigation menu is part of authenticated application layout.

---

## 7) Route Protection

### 7.1 ProtectedRoute Component

**File:** `frontend/src/components/ProtectedRoute.jsx`

Logic:

* If no token → `<Navigate to="/login" replace />`
* If token exists → render children

Protected routes:

* `/documents`
* `/documents/upload`
* `/documents/:id/validate`

Prevents unauthorized UI access.

---

## 8) Persistent Authentication

### 8.1 App Initialization

**File:** `frontend/src/App.jsx`

On application mount:

```
const token = localStorage.getItem('auth_token');
if (token) {
    setAuthToken(token);
}
```

Ensures:

* Token restored after refresh
* Authorization header automatically reattached

---

## 9) Navbar Authentication Integration

**File:** `frontend/src/components/Navbar.jsx`

### 9.1 Conditional Rendering

If authenticated:

* Documents
* Upload
* Logout

If not authenticated:

* Login link only

### 9.2 Logout Handling

* Calls `auth.logout()`
* Redirects to `/login` with `replace: true`
* Prevents back navigation to protected routes

---

## 10) Testing & Validation

### 10.1 Test 1 – Login Flow

* Redirect to `/login`
* Valid credentials authenticate
* Redirect to `/documents`
* Documents list loads correctly

Result: Passed

---

### 10.2 Test 2 – Logout Flow

* Logout clears token
* Redirect to `/login`
* Protected routes inaccessible after logout

Result: Passed

---

### 10.3 Test 3 – Refresh Test

* Refresh preserves session
* Authorization header restored
* No forced re-login

Result: Passed

---

### 10.4 Test 4 – Invalid Credentials

* Incorrect credentials return error
* UI displays correct message

Result: Passed

---

### 10.5 Test 5 – Corrupted Token

* Manual token modification triggers 401
* Interceptor clears token
* Redirect to `/login`

Result: Passed

All authentication scenarios validated successfully.

---

## 11) Architecture Validation

### Authentication flow (Frontend + Backend)

```
LOGIN (React)
    |
    v
POST /api/login (Laravel)
    |
    v
Sanctum token issued
    |
    v
Stored in localStorage
    |
    v
Axios Authorization: Bearer <token>
    |
    v
Protected UI routes accessible
```

401 handling:

```
Invalid / revoked token
    |
    v
Laravel returns 401
    |
    v
Axios interceptor clears token
    |
    v
Redirect to /login
```

---

## 12) Files Modified Summary

### Frontend

| File                                | Description                         |
| ----------------------------------- | ----------------------------------- |
| `src/pages/Login.jsx`               | Login UI and validation             |
| `src/components/ProtectedRoute.jsx` | Route protection wrapper            |
| `src/services/api.js`               | Axios instance + 401 interceptor    |
| `src/services/auth.js`              | Auth service abstraction            |
| `src/utils/setAuthToken.js`         | Token header utility                |
| `src/components/Navbar.jsx`         | Conditional auth rendering          |
| `src/App.jsx`                       | Persistent auth + protected routing |

### Backend

No modifications.

---

## 13) Sprint 4 Progress

### Stories completed (Day 9)

| Story ID | Description                 | Status   |
| -------- | --------------------------- | -------- |
| US-023   | Frontend authentication UI  | Complete |
| TS-042   | Axios token interceptor     | Complete |
| TS-043   | Route protection mechanism  | Complete |
| TS-044   | Persistent session handling | Complete |

Sprint 4 authentication layer now operational at frontend level.

---

## 14) System State at End of Day 9

### Current capabilities

* Secure login interface
* Token-based session management
* Automatic logout on 401
* Persistent login after refresh
* Protected frontend routes
* Backend Sanctum authentication functional
* Document routes still backend-open (intentional)

System now supports full authenticated UI flow.

---

## Out of Scope (intentional for Day 9)

* Backend document route protection (Day 10)
* Role-based access control
* Refresh tokens
* Password reset
* Email verification
* Token expiration strategy
* User profile UI

