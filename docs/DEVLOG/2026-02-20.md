# Project PFE – Day 10 Implementation Log

**Date:** 2026-02-20
**Goal (Day 10):** Enforce backend authentication on document routes (auth:sanctum), secure full upload → processing → validation workflow, and validate end-to-end protected system behavior.

---

## Deliverables (created/updated)

* `backend/routes/api.php`
* `backend/app/Http/Middleware/Authenticate.php`
* `backend/app/Exceptions/Handler.php`
* `frontend/src/pages/DocumentsList.jsx`
* `frontend/src/pages/DocumentUpload.jsx`
* `frontend/src/pages/DocumentValidation.jsx`

> Backend document routes now fully protected.
> Frontend fully aligned with authenticated API client.
> End-to-end secured workflow validated successfully.

---

## 1) Security Enforcement – Backend

### 1.1 Route Protection

All document-related routes are now protected using:

```php
Route::middleware('auth:sanctum')->prefix('documents')->group(function () {
    Route::post('/', [DocumentController::class, 'store']);
    Route::get('/', [DocumentController::class, 'index']);
    Route::get('/{document}', [DocumentController::class, 'show']);
    Route::post('/{document}/validate', [DocumentValidationController::class, 'validateDocument']);
});
```

Decision: **Protect ALL document routes** (GET + POST).

Rationale:

* Internal insurance system
* No public document access required
* Full API-level enforcement of authentication

---

### 1.2 API Authentication Behavior

Verified behaviors:

Without token:

* `GET /api/documents` → 401 Unauthorized
* JSON response returned (no redirect)

With valid token:

* All document routes accessible
* Proper Sanctum token validation

---

### 1.3 API Exception Handling Adjustment

Modified:

`app/Exceptions/Handler.php`

Added explicit unauthenticated JSON response:

```php
protected function unauthenticated($request, AuthenticationException $exception)
{
    return response()->json([
        'message' => 'Unauthenticated.'
    ], 401);
}
```

Purpose:

* Prevent Laravel redirect to undefined `login` route
* Ensure API-first behavior
* Maintain consistent JSON responses

---

## 2) Middleware Adjustment

Modified:

`app/Http/Middleware/Authenticate.php`

Ensured:

```php
protected function redirectTo(Request $request): ?string
{
    return null;
}
```

Prevents web redirection logic for API routes.

---

## 3) Frontend Alignment

### 3.1 Unified API Client Usage

All document pages updated to use:

```js
import api from '../services/api';
```

Removed direct axios usage in:

* DocumentsList.jsx
* DocumentUpload.jsx
* DocumentValidation.jsx

Ensures:

* Authorization header automatically attached
* 401 interceptor functions correctly
* Centralized baseURL management

---

### 3.2 Multipart Upload Fix

Fixed upload call to:

```js
const formData = new FormData();
formData.append('file', file);

await api.post('/documents', formData);
```

Removed manual `Content-Type` header to allow Axios to set proper multipart boundaries.

---

## 4) PHP Upload Configuration Issue

### 4.1 Root Cause Identified

Upload initially failed with:

```
422 Unprocessable Content
"The file failed to upload."
```

Cause:
PHP upload limits too low:

```
upload_max_filesize = 2M
post_max_size = 8M
```

Test file size: 2.79MB

PHP rejected file before Laravel validation.

---

### 4.2 Configuration Fix

Updated php.ini:

```
upload_max_filesize = 40M
post_max_size = 40M
```

Restarted Apache.

Result:
File upload successful.

---

## 5) End-to-End Secured Workflow Validation

### 5.1 Full Flow Tested

Scenario executed:

1. Login (Sanctum token issued)
2. Upload invoice image
3. File stored successfully
4. Job dispatched to queue
5. FastAPI OCR executed
6. Extraction completed
7. Confidence scores calculated
8. Low-confidence warning displayed
9. Manual correction performed
10. Document validated
11. Status updated to VALIDATED

Status lifecycle verified:

```
UPLOADED → PROCESSING → PROCESSED → VALIDATED
```

All transitions functioning correctly under protected API.

---

## 6) AI Extraction Behavior Observed

Test invoice produced:

* Invoice Date → 85% confidence
* Provider Name → 65% confidence (low)
* Total Amount → 80% confidence

System behavior:

* Low confidence field highlighted
* Warning panel displayed
* Manual correction allowed
* Validation persisted correctly

Human-in-the-Loop mechanism validated successfully.

---

## 7) Security Validation Tests

### 7.1 No Token Access

Manual token removal from localStorage:

* Refresh `/documents`
* Redirected to `/login`
* Protected routes inaccessible

Result: Passed

---

### 7.2 Token Expiry Simulation

Corrupted token test:

* Backend returns 401
* Axios interceptor clears token
* Redirect to login

Result: Passed

---

### 7.3 Upload Security Test

Attempted upload without authentication:

* 401 Unauthorized
* JSON error returned

Result: Passed

---

## 8) System Architecture State (After Day 10)

Before:

Frontend (protected) → Laravel API (open documents routes) → MySQL

After:

Frontend (protected)
↓
Laravel API (auth:sanctum enforced on all documents routes)
↓
Queue Worker
↓
FastAPI OCR Service
↓
MySQL + Extraction Versioning

System now fully secured at API level.

---

## 9) Files Modified Summary

### Backend

| File                        | Purpose                           |
| --------------------------- | --------------------------------- |
| routes/api.php              | Protected document routes         |
| Middleware/Authenticate.php | Prevent redirect behavior         |
| Exceptions/Handler.php      | API JSON unauthenticated handling |

### Frontend

| File                   | Purpose                          |
| ---------------------- | -------------------------------- |
| DocumentsList.jsx      | Unified API client               |
| DocumentUpload.jsx     | Secure multipart upload          |
| DocumentValidation.jsx | Protected fetch & validate calls |

---

## 10) Sprint 4 Progress

### Stories Completed (Day 10)

| Story ID | Description                     | Status   |
| -------- | ------------------------------- | -------- |
| US-024   | Protect document API routes     | Complete |
| TS-045   | Align frontend with secured API | Complete |
| TS-046   | Secure multipart upload         | Complete |
| TS-047   | Validate full secured workflow  | Complete |

Sprint 4 backend security layer completed.

---

## 11) System State at End of Day 10

Current system capabilities:

* Fully authenticated document API
* Secure upload handling
* Async queue-based processing
* OCR extraction with confidence scoring
* Human-in-the-loop validation
* Persistent session management
* Automatic 401 handling
* Protected end-to-end workflow

MVP now secured at both frontend and backend levels.

---

## Out of Scope (intentional for Day 10)

* Role-based access control (RBAC)
* Admin dashboard
* Audit trail UI visualization
* Refresh tokens
* Password reset system
* Production deployment hardening


