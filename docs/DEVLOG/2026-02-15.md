# Project PFE – Day 6 Implementation Log

**Date:** 2026-02-15  
**Goal (Day 6):** Implement Human-in-the-Loop (HITL) validation pipeline with audit trail and version control. Complete the workflow: Upload → OCR (FastAPI) → Extraction → Validation (React) → Database Update.

---

## Deliverables (created/updated)

- `database/migrations/2026_02_15_114643_create_field_corrections_table.php`
- `app/Models/FieldCorrection.php`
- `app/Models/Document.php` *(updated: fieldCorrections relationship)*
- `app/Http/Controllers/Api/DocumentValidationController.php`
- `app/Http/Controllers/Api/DocumentController.php` *(updated: show with extraction)*
- `routes/api.php` *(validation route)*
- `frontend/src/pages/DocumentValidation.jsx`
- `frontend/src/components/ConfidenceBadge.jsx`
- `frontend/src/App.jsx` *(router)*

---

## Implementation Timeline

**Total Duration:** ~9 hours (full work day)

### Phase Breakdown

| Phase | Duration | Activities | Key Deliverables |
|-------|----------|------------|------------------|
| Phase 0: Pre-Implementation Checks | 30 min | Database constraint verification, enum validation, planning | ai_request_id constraint confirmed (NOT NULL), DocumentStatus enum verified |
| Phase 1: Database Layer | 1h | Create migration, define FieldCorrection model, add relationships | field_corrections table, model with fillable fields |
| Phase 2: Backend API | 3h | DocumentValidationController, update DocumentController::show(), add routes, locking logic | POST /validate endpoint, updated GET /documents/{id}, transaction-safe validation |
| Phase 3: Backend Testing | 1h | Postman test suite, database verification, edge case testing | All Postman tests passing, database integrity confirmed |
| Phase 4: Frontend Development | 3h | DocumentValidation page, ConfidenceBadge component, router, CSS fixes | React UI, Bootstrap integration |
| Phase 5: End-to-End Testing | 30 min | Browser testing, workflow validation | Full pipeline verified |

### Time Distribution

- Backend: 55% (5 hours)
- Frontend: 33% (3 hours)
- Testing/Validation: 17% (1.5 hours)
- Documentation: (tracked separately)

---

## 1) Database Changes

### 1.1 `field_corrections` table

**Purpose:** Record original and corrected values for each field changed during validation.

| Field | Type | Description |
|---|---|---|
| id | bigIncrements | Primary key |
| document_id | foreignId | Link to documents |
| field_name | string | Field identifier |
| original_value | text (nullable) | AI-extracted value |
| corrected_value | text (nullable) | User-corrected value |
| user_id | foreignId (nullable) | Future auth integration |
| timestamps | - | created_at, updated_at |

**Index:** `(document_id, field_name)` for query optimization.

**Key decisions:**
- `original_value` and `corrected_value` nullable to handle missing AI data and user deletions
- `user_id` nullable (auth deferred)
- Cascade delete when document is deleted

### 1.2 Verification before implementation

Constraint verification performed before implementing version control:
- `ai_request_id` in `extractions` is NOT NULL; must be preserved when creating new versions
- Document status uses `DocumentStatus` enum; code uses `DocumentStatus::PROCESSED` and `DocumentStatus::VALIDATED`

---

## 2) Backend (Laravel)

### 2.1 FieldCorrection model

**File:** `app/Models/FieldCorrection.php`

- Fillable: `document_id`, `field_name`, `original_value`, `corrected_value`, `user_id`
- Relationships: `belongsTo(Document::class)`, `belongsTo(User::class)`

Document model updated with `hasMany(FieldCorrection::class)`.

### 2.2 DocumentValidationController

**File:** `app/Http/Controllers/Api/DocumentValidationController.php`

**Status eligibility:** Only documents with status `PROCESSED` can be validated. Returns 400 if status is already `VALIDATED`.

**Field whitelisting:** Allowed fields are `invoice_date`, `provider_name`, `total_ttc`. Input filtered to these fields only.

**Pessimistic locking:** Latest extraction locked with `lockForUpdate()` to prevent concurrent validation from creating duplicate versions.

**ai_request_id preservation:** New extraction versions inherit `ai_request_id` from previous version (NOT NULL constraint requirement).

**Change detection:** Corrections stored only for fields that changed. Numeric comparison for `total_ttc`; string comparison for others.

**Transaction:** All operations (field corrections, new extraction version, document status update) run inside a single `DB::transaction()`.

### 2.3 DocumentController

**File:** `app/Http/Controllers/Api/DocumentController.php`

`show()` method extended to include `latest_extraction` with `version`, `fields`, `confidence`, `warnings`, and `meta`. Returns null if no extraction exists.

---

## 3) AI Microservice (FastAPI)

No changes. FastAPI continues to handle OCR and extraction only. Validation is handled by Laravel and React.

---

## 4) API Changes

### 4.1 New endpoint

| Method | URL | Purpose |
|--------|-----|---------|
| POST | `/api/documents/{document}/validate` | Submit validated fields |

### 4.2 Request body

```json
{
  "fields": {
    "invoice_date": "2017-04-04",
    "provider_name": "Ma pharmacie locale",
    "total_ttc": 95.52
  }
}
```

### 4.3 Response (200)

```json
{
  "message": "Document validated successfully.",
  "document": { "id": 5, "status": "VALIDATED" },
  "latest_extraction": { "version": 2, "fields": {...} }
}
```

### 4.4 Error responses

- 400: Document not eligible (already VALIDATED or not PROCESSED)
- 500: Extraction missing ai_request_id (data integrity)

---

## 5) Frontend (React)

### 5.1 Dependencies

- axios (HTTP client)
- react-router-dom (routing)
- bootstrap, bootstrap-icons (UI)

### 5.2 Components

**ConfidenceBadge.jsx:** Displays confidence score as color-coded badge. Thresholds: green (≥85%), yellow (70–84%), red (<70%).

**DocumentValidation.jsx:** Main validation page. Fetches document via GET `/api/documents/{id}`, displays fields in editable table with confidence badges and warnings panel, submits via POST `/api/documents/{id}/validate`.

### 5.3 Behavior

- Fields table: editable inputs for `invoice_date` (date), `provider_name` (text), `total_ttc` (number)
- Rows with confidence below 70% highlighted
- Validate button disabled when document already VALIDATED or during submission
- Loading and error states handled

---

## 6) Testing & Validation

### 6.1 Backend (Postman)

**Test 1 – GET document with extraction**
- Request: `GET /api/documents/5`
- Response: 200 with `latest_extraction` containing `fields`, `confidence`, `warnings`

**Test 2 – Validation with corrections**
- Request: `POST /api/documents/5/validate` with corrected fields
- Response: 200; status changed to VALIDATED; extraction version incremented to 2
- Database: 2 rows in `field_corrections` (invoice_date, provider_name); total_ttc unchanged, not stored

**Test 3 – Re-validation prevention**
- Request: `POST /api/documents/5/validate` (document already VALIDATED)
- Response: 400 with message "Document not eligible for validation"

### 6.2 Database verification

- `field_corrections`: stores only changed fields; original and corrected values present
- `extractions`: version 2 created with same `ai_request_id` as version 1
- `documents`: status updated to VALIDATED

### 6.3 End-to-end (browser)

- Navigate to `/documents/5/validate`
- Edit fields, submit validation
- Status badge updates; button disables; success message displayed

### 6.4 Detailed Test Results

#### Test 1: Document 5 (Quebec Pharmacy Invoice)

**Initial State:**
- File: facture3.png (63 KB)
- Status: PROCESSED
- Extraction Version: 1

**OCR Results (Before Validation):**
```json
{
  "fields": {
    "invoice_date": null,
    "provider_name": "Ma pharmacie locale Annie Morin 123456",
    "total_ttc": 95.52
  },
  "confidence": {
    "invoice_date": 0.0,
    "provider_name": 0.65,
    "total_ttc": 0.80
  },
  "warnings": [
    "Missing required field: 'invoice_date'",
    "Low confidence for field 'provider_name': 65%"
  ]
}
```

**Human Corrections Applied:**
- invoice_date: null → "2017-04-04" (manually entered)
- provider_name: "Ma pharmacie locale Annie Morin 123456" → "Ma pharmacie locale" (cleaned)
- total_ttc: 95.52 → 95.52 (unchanged)

---

## 7) Architecture Validation

### Workflow (current state)

```
UPLOADED (t=0s)
    |
    v
PROCESSING (t=1s) [Queue + FastAPI OCR]
    |
    v
PROCESSED (version 1, extraction stored)
    |
    v [React: GET /documents/{id}, user edits, POST /validate]
    |
VALIDATED (version 2, corrections in field_corrections)
```

### System components

```
+----------------+
| React Frontend | GET /api/documents/{id}
| (Vite :5173)   | POST /api/documents/{id}/validate
+-------+--------+
        |
        v
+-------+----------------------------------+
| Laravel API (:8000)                      |
| - DocumentController::show()             |
| - DocumentValidationController::validateDocument() |
+-------+----------------------------------+
        |
        v [DB::transaction]
+-------+----------------------------------+
| MySQL                                  |
| - documents (status)                    |
| - extractions (versioned)               |
| - field_corrections (audit trail)       |
| - ai_requests                          |
+------------------------------------------+
```

Upload and OCR flow unchanged from Day 5: Client → Laravel → Queue Worker → FastAPI (:8001) → Laravel Persistence. FastAPI handles OCR and extraction only; it is not invoked during validation.

### Day 2 design compliance

- Laravel owns workflow states and persistence
- FastAPI handles AI processing only (stateless)
- React communicates only with Laravel
- Audit trail in `field_corrections`
- Version control in `extractions`
- Status workflow: PROCESSED → VALIDATED


---

## 8) Files Modified Summary

### Backend

| File | Lines | Description |
|------|-------|-------------|
| `database/migrations/2026_02_15_114643_create_field_corrections_table.php` | ~40 | field_corrections migration |
| `app/Models/FieldCorrection.php` | ~25 | Model with relationships |
| `app/Models/Document.php` | +5 | fieldCorrections() relation |
| `app/Http/Controllers/Api/DocumentValidationController.php` | ~120 | Validation endpoint with locking |
| `app/Http/Controllers/Api/DocumentController.php` | +15 | show() with latest_extraction |
| `routes/api.php` | +3 | Validation route |

### Frontend

| File | Lines | Description |
|------|-------|-------------|
| `src/pages/DocumentValidation.jsx` | ~250 | Main validation page |
| `src/components/ConfidenceBadge.jsx` | ~50 | Confidence badge component |
| `src/App.jsx` | ~20 | Router setup |
| `src/App.css` | ~30 | App-level styles |
| `src/index.css` | ~40 | Global layout fixes |

---

## 9) Sprint 3 Progress

### Stories Completed (Day 6)

| Story ID | Description | Priority | Points | Status | Notes |
|----------|-------------|----------|--------|--------|-------|
| US-017 | Display extracted fields in UI | Must Have | 5 | Complete | DocumentValidation page with table |
| US-018 | Enable field correction interface | Must Have | 5 | Complete | Editable inputs with live updates |
| US-019 | Store correction audit trail | Must Have | 3 | Complete | field_corrections table |
| US-020 | Implement version control | Must Have | 3 | Complete | extractions.version increments |
| TS-037 | Add pessimistic locking | Technical | 2 | Complete | lockForUpdate() prevents races |
| TS-038 | Create validation endpoint | Technical | 2 | Complete | POST /validate with transactions |

**Day 6 Story Points:** 20/20 = **100% Complete**

### Cumulative Sprint 3 Progress

| Story ID | Description | Points | Day Completed | Status |
|----------|-------------|--------|---------------|--------|
| US-011 | HTTP FastAPI integration | 5 | Day 5 | Complete |
| US-015 | Failure audit trail | 2 | Day 5 | Complete |
| US-016 | Idempotence guards | 3 | Day 5 | Complete |
| TS-036 | Refactor AIService | 2 | Day 5 | Complete |
| US-017 | Extraction display UI | 5 | Day 6 | Complete |
| US-018 | Field correction UI | 5 | Day 6 | Complete |
| US-019 | Correction audit trail | 3 | Day 6 | Complete |
| US-020 | Version control | 3 | Day 6 | Complete |
| TS-037 | Pessimistic locking | 2 | Day 6 | Complete |
| TS-038 | Validation endpoint | 2 | Day 6 | Complete |

**Sprint 3 Total:** 32/32 story points = **100% Complete**

**Sprint 3 Duration:** 2 days (Day 5–6)

**Velocity:** 16 story points/day (above target of 12)

### Definition of Done (DoD) Verification

**For US-018 (Field correction UI) to be "Done":**
- [x] React component created and tested
- [x] All 3 fields (invoice_date, provider_name, total_ttc) editable
- [x] Confidence badges displayed with correct colors
- [x] Low-confidence fields highlighted (yellow background)
- [x] Validation button submits to API
- [x] Success/error states handled
- [x] Loading state shown during submission
- [x] No console errors
- [x] Responsive design
- [x] Code committed to Git
- [x] Tested end-to-end

**All DoD criteria met**


### Risk Log Updates

| Risk | Mitigation | Status Day 6 |
|------|------------|--------------|
| Concurrent validation conflicts | Pessimistic locking | Mitigated |
| Data integrity violations | Transaction wrapping | Mitigated |
| Poor OCR quality | HITL allows manual entry | Accepted (by design) |
| Frontend layout issues | CSS fixes applied | Resolved |

### Next Sprint (Sprint 4) Planning

**Planned Stories:**
- US-021: Authentication system (Sanctum) - 8 points
- US-022: Documents list page with filters - 5 points
- US-023: Dashboard with statistics - 5 points
- US-024: Improve OCR (Phase 1 preprocessing) - 3 points

**Estimated Sprint 4 Duration:** 2 days  
**Target Velocity:** 16 points/day (based on Sprint 3 actual)

---

## 10) System State at End of Day 6

### Current capabilities

- Document upload and async processing
- Real OCR via FastAPI and Tesseract
- Extraction storage with versioning
- Validation form with editable fields and confidence display
- Audit trail of corrections in `field_corrections`
- Re-validation prevented for VALIDATED documents
- Full workflow: UPLOADED → PROCESSING → PROCESSED → VALIDATED

### Current workflow

```
UPLOADED
    |
PROCESSING (queue + FastAPI OCR)
    |
PROCESSED / FAILED
    |
VALIDATED (HITL complete)
```

---

## Out of Scope (intentional for Day 6)

- Authentication (user_id in field_corrections remains null)
- Documents list page with filters
- Advanced date parsing (e.g. French month names)
- Multi-page PDF support
- Export of validated documents
- WebSocket real-time updates
